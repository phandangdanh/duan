<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stock Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">Test Stock Fix</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Issue Fixed</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <h6>‚úÖ Fixed:</h6>
                            <ul class="mb-0">
                                <li><strong>Stock Data Creation:</strong> T·ª± ƒë·ªông t·∫°o stock data n·∫øu ch∆∞a c√≥</li>
                                <li><strong>Stock Update:</strong> Tr·ª´ s·ªë l∆∞·ª£ng ƒë√∫ng c√°ch</li>
                                <li><strong>Persistence:</strong> L∆∞u v√†o localStorage</li>
                                <li><strong>Display Update:</strong> C·∫≠p nh·∫≠t UI real-time</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testStockCreation()">Test Stock Creation</button>
                        <button class="btn btn-success mb-2" onclick="testStockUpdate()">Test Stock Update</button>
                        <button class="btn btn-warning mb-2" onclick="checkLocalStorage()">Check LocalStorage</button>
                        <button class="btn btn-danger mb-2" onclick="clearStock()">Clear Stock</button>
                        
                        <div id="test-results" class="mt-3">
                            <p class="text-muted">Click buttons to test...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Expected Console Logs</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6>üìã When Adding to Cart (Fixed):</h6>
                            <pre class="bg-light p-3">
üõí Adding to cart...
üõí Server response: {success: true}
üì¶ Current stock before update: 10
üì¶ Quantity to subtract: 1
üì¶ Updating local stock...
üì¶ updateLocalStock called: {stockType: "main", quantity: 1}
üì¶ Creating initial stock data: {mainStock: 10, variants: {}}
üì¶ Current stock data: {mainStock: 10, variants: {}}
üì¶ Main product: 10 ‚Üí 9
üì¶ Stock saved to localStorage
üîç checkStockAndSwitch called, main stock: 9
‚úÖ Main product has stock, resetting to main product
üõí Adding to local cart...
‚úÖ Cart addition completed
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Product Detail Page</h5>
                    </div>
                    <div class="card-body">
                        <a href="http://localhost:8000/sanpham/106" target="_blank" class="btn btn-success mb-3">
                            <i class="fas fa-external-link-alt"></i> Test Product Detail Page
                        </a>
                        
                        <div class="alert alert-warning">
                            <h6>‚ö†Ô∏è Test Steps:</h6>
                            <ol class="mb-0">
                                <li>Open Product Detail Page</li>
                                <li>Check initial stock: "S·ªë l∆∞·ª£ng c√≥ s·∫µn: 10"</li>
                                <li>Click "Th√™m v√†o gi·ªè" button</li>
                                <li>Check console for: "üì¶ Creating initial stock data"</li>
                                <li>Verify stock decreases: "S·ªë l∆∞·ª£ng c√≥ s·∫µn: 9"</li>
                                <li>Add more items and watch stock decrease</li>
                                <li>Refresh page and check persistence</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function testStockCreation() {
            console.log('üß™ Testing stock creation...');
            
            // Clear existing data
            localStorage.removeItem('product_stock_106');
            
            // Simulate getLocalStock() behavior
            const storageKey = 'product_stock_106';
            const stored = localStorage.getItem(storageKey);
            
            if (stored) {
                console.log('üì¶ Found stored stock data:', JSON.parse(stored));
            } else {
                const initialStock = {
                    mainStock: 10,
                    variants: {}
                };
                console.log('üì¶ Creating initial stock data:', initialStock);
                localStorage.setItem(storageKey, JSON.stringify(initialStock));
            }
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ Stock Creation Test:</h6>
                    <p>Initial stock data created in localStorage</p>
                    <p>Main stock: 10</p>
                    <p>Variants: {}</p>
                </div>
            `;
        }
        
        function testStockUpdate() {
            console.log('üß™ Testing stock update...');
            
            // Get current stock
            const storageKey = 'product_stock_106';
            let stockData = JSON.parse(localStorage.getItem(storageKey) || '{"mainStock": 10, "variants": {}}');
            
            const oldStock = stockData.mainStock;
            const quantity = 2;
            stockData.mainStock = Math.max(0, oldStock - quantity);
            
            localStorage.setItem(storageKey, JSON.stringify(stockData));
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-info">
                    <h6>üì¶ Stock Update Test:</h6>
                    <p>Main stock: ${oldStock} ‚Üí ${stockData.mainStock}</p>
                    <p>Quantity subtracted: ${quantity}</p>
                    <p>Stock saved to localStorage</p>
                </div>
            `;
        }
        
        function checkLocalStorage() {
            const stockData = localStorage.getItem('product_stock_106');
            const cartData = localStorage.getItem('cart_data');
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-info">
                    <h6>üíæ LocalStorage Data:</h6>
                    <p><strong>Stock Data:</strong></p>
                    <pre>${stockData || 'No stock data'}</pre>
                    <p><strong>Cart Data:</strong></p>
                    <pre>${cartData || 'No cart data'}</pre>
                </div>
            `;
        }
        
        function clearStock() {
            localStorage.removeItem('product_stock_106');
            localStorage.removeItem('cart_data');
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-warning">
                    <h6>üóëÔ∏è Stock Cleared</h6>
                    <p>All stock and cart data removed from localStorage</p>
                </div>
            `;
        }
        
        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Stock fix test page loaded');
            checkLocalStorage();
        });
    </script>
</body>
</html>
