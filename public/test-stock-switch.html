<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stock Switch & Variant Error</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">Test Stock Switch & Variant Error</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Issues to Fix</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <h6>âŒ Issues:</h6>
                            <ul class="mb-0">
                                <li><strong>Auto-switch:</strong> Khi háº¿t hÃ ng chÃ­nh khÃ´ng tá»± Ä‘á»™ng chuyá»ƒn sang mÃ u sáº¯c</li>
                                <li><strong>Variant Error:</strong> Khi chá»n mÃ u + size thÃ´ng bÃ¡o lá»—i khi thÃªm vÃ o giá»</li>
                                <li><strong>Stock Logic:</strong> CÃ³ thá»ƒ stock calculation khÃ´ng Ä‘Ãºng</li>
                                <li><strong>Error Message:</strong> ThÃ´ng bÃ¡o lá»—i khÃ´ng rÃµ rÃ ng</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testAutoSwitch()">Test Auto-switch</button>
                        <button class="btn btn-success mb-2" onclick="testVariantError()">Test Variant Error</button>
                        <button class="btn btn-warning mb-2" onclick="simulateOutOfStock()">Simulate Out of Stock</button>
                        <button class="btn btn-info mb-2" onclick="checkStockData()">Check Stock Data</button>
                        
                        <div id="test-results" class="mt-3">
                            <p class="text-muted">Click buttons to test...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Expected Console Logs</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6>ğŸ“‹ When Main Product Out of Stock:</h6>
                            <pre class="bg-light p-3">
ğŸ” checkStockAndSwitch called, main stock: 0
ğŸ” Product variants: [array of variants]
ğŸ” Variants length: 5
âš ï¸ Main product out of stock, switching to variants
ğŸ” First variant: {id: 1, id_mausac: 1, mausac: {ten: "Äá»"}, ...}
ğŸ¨ Auto-selecting first color: Äá»
ğŸ¨ selectColor called: {colorId: 1, colorName: "Äá»"}
ğŸ¨ Selecting new color: Äá»
ğŸ¨ Selected color after update: 1
ğŸ“ renderSizeOptions called
ğŸ“ Size options rendered
                            </pre>
                        </div>
                        
                        <div class="alert alert-warning">
                            <h6>ğŸ“‹ When Adding Variant to Cart:</h6>
                            <pre class="bg-light p-3">
ğŸ›’ Adding to cart...
ğŸ›’ Cart data: {product_id: 106, variant_id: 1, color_id: 1, size_id: 1, quantity: 1}
ğŸ›’ Stock type: variant
ğŸ“¦ getCurrentStock called
ğŸ” getSelectedVariant called
ğŸ” Selected color: 1
ğŸ” Selected size: 1
ğŸ” Found variant: {id: 1, id_mausac: 1, id_size: 1, soLuong: 5, ...}
ğŸ“¦ Variant stock (variant_1): 5
ğŸ“¦ Current stock before update: 5
ğŸ“¦ Quantity to subtract: 1
âœ… Cart addition completed
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Product Detail Page</h5>
                    </div>
                    <div class="card-body">
                        <a href="http://localhost:8000/sanpham/106" target="_blank" class="btn btn-success mb-3">
                            <i class="fas fa-external-link-alt"></i> Test Product Detail Page
                        </a>
                        
                        <div class="alert alert-warning">
                            <h6>âš ï¸ Test Steps:</h6>
                            <ol class="mb-0">
                                <li><strong>Test Auto-switch:</strong>
                                    <ul>
                                        <li>Add main product to cart until stock = 0</li>
                                        <li>Refresh page</li>
                                        <li>Check if auto-switches to variants</li>
                                        <li>Look for "âš ï¸ Sáº£n pháº©m chÃ­nh Ä‘Ã£ háº¿t hÃ ng!" message</li>
                                    </ul>
                                </li>
                                <li><strong>Test Variant Error:</strong>
                                    <ul>
                                        <li>Select color (e.g., "Äá»")</li>
                                        <li>Select size (e.g., "S")</li>
                                        <li>Click "ThÃªm vÃ o giá»"</li>
                                        <li>Check console for variant selection logs</li>
                                        <li>Check if error message appears</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock product data
        const mockProduct = {
            id: 106,
            soLuong: 0, // Out of stock
            chitietsanpham: [
                { id: 1, id_mausac: 1, id_size: 1, soLuong: 5, mausac: { ten: 'Äá»' }, size: { ten: 'S' } },
                { id: 2, id_mausac: 1, id_size: 2, soLuong: 3, mausac: { ten: 'Äá»' }, size: { ten: 'M' } },
                { id: 3, id_mausac: 2, id_size: 1, soLuong: 4, mausac: { ten: 'VÃ ng' }, size: { ten: 'S' } }
            ]
        };
        
        let selectedColor = null;
        let selectedSize = null;
        
        function checkStockAndSwitch() {
            const mainStock = mockProduct.soLuong || 0;
            console.log('ğŸ” checkStockAndSwitch called, main stock:', mainStock);
            console.log('ğŸ” Product variants:', mockProduct.chitietsanpham);
            console.log('ğŸ” Variants length:', mockProduct.chitietsanpham?.length);
            
            if (mainStock === 0 && mockProduct.chitietsanpham && mockProduct.chitietsanpham.length > 0) {
                console.log('âš ï¸ Main product out of stock, switching to variants');
                console.log('âš ï¸ Sáº£n pháº©m chÃ­nh Ä‘Ã£ háº¿t hÃ ng! Tá»± Ä‘á»™ng chuyá»ƒn sang biáº¿n thá»ƒ...');
                
                // Auto-select first color if available
                const firstVariant = mockProduct.chitietsanpham[0];
                console.log('ğŸ” First variant:', firstVariant);
                
                if (firstVariant && firstVariant.id_mausac) {
                    console.log('ğŸ¨ Auto-selecting first color:', firstVariant.mausac.ten);
                    selectColor(firstVariant.id_mausac, firstVariant.mausac.ten);
                } else {
                    console.log('âŒ First variant has no color data');
                }
            } else if (mainStock > 0) {
                console.log('âœ… Main product has stock, resetting to main product');
            } else {
                console.log('âŒ No stock available for main product or variants');
            }
        }
        
        function selectColor(colorId, colorName) {
            console.log('ğŸ¨ selectColor called:', { colorId, colorName });
            selectedColor = colorId;
            selectedSize = null;
            console.log('ğŸ¨ Selected color after update:', selectedColor);
        }
        
        function getSelectedVariant() {
            console.log('ğŸ” getSelectedVariant called');
            console.log('ğŸ” Selected color:', selectedColor);
            console.log('ğŸ” Selected size:', selectedSize);
            
            if (!selectedColor || !selectedSize || !mockProduct.chitietsanpham) {
                console.log('ğŸ” No variant selected (missing color, size, or variants)');
                return null;
            }
            
            const variant = mockProduct.chitietsanpham.find(v => 
                v.id_mausac === selectedColor && v.id_size === selectedSize
            );
            
            console.log('ğŸ” Found variant:', variant);
            return variant;
        }
        
        function getCurrentStock() {
            console.log('ğŸ“¦ getCurrentStock called');
            const variant = getSelectedVariant();
            const stockData = { mainStock: 0, variants: { variant_1: 5, variant_2: 3, variant_3: 4 } };
            
            console.log('ğŸ“¦ Selected variant:', variant);
            console.log('ğŸ“¦ Stock data:', stockData);
            
            if (variant) {
                const variantKey = `variant_${variant.id}`;
                const variantStock = stockData.variants?.[variantKey] || variant.soLuong || 0;
                console.log(`ğŸ“¦ Variant stock (${variantKey}):`, variantStock);
                return variantStock;
            } else {
                const mainStock = stockData.mainStock || mockProduct.soLuong || 0;
                console.log('ğŸ“¦ Main product stock:', mainStock);
                return mainStock;
            }
        }
        
        function testAutoSwitch() {
            console.log('ğŸ§ª Testing auto-switch...');
            checkStockAndSwitch();
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-success">
                    <h6>âœ… Auto-switch Test:</h6>
                    <p>Main stock: ${mockProduct.soLuong}</p>
                    <p>Variants available: ${mockProduct.chitietsanpham.length}</p>
                    <p>Auto-selected color: ${selectedColor ? 'Yes' : 'No'}</p>
                    <p>Check console for detailed logs</p>
                </div>
            `;
        }
        
        function testVariantError() {
            console.log('ğŸ§ª Testing variant error...');
            
            // Simulate selecting color and size
            selectedColor = 1;
            selectedSize = 1;
            
            const variant = getSelectedVariant();
            const currentStock = getCurrentStock();
            const quantity = 1;
            
            if (quantity > currentStock) {
                const itemType = variant ? 'biáº¿n thá»ƒ' : 'sáº£n pháº©m chÃ­nh';
                const itemName = variant ? `${variant.mausac?.ten || 'MÃ u'} - ${variant.size?.ten || 'Size'}` : 'sáº£n pháº©m chÃ­nh';
                console.log(`âŒ Stock error: ${itemType} "${itemName}" - Requested: ${quantity}, Available: ${currentStock}`);
                
                document.getElementById('test-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ Variant Error Test:</h6>
                        <p>Error: KhÃ´ng Ä‘á»§ hÃ ng! ${itemType} "${itemName}" chá»‰ cÃ²n ${currentStock} sáº£n pháº©m</p>
                        <p>Requested: ${quantity}</p>
                        <p>Available: ${currentStock}</p>
                    </div>
                `;
            } else {
                console.log('âœ… Stock sufficient, adding to cart...');
                document.getElementById('test-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>âœ… Variant Success Test:</h6>
                        <p>Success: ÄÃ£ thÃªm vÃ o giá» hÃ ng</p>
                        <p>Variant: ${variant ? `ID ${variant.id}` : 'Main Product'}</p>
                        <p>Stock: ${currentStock} â†’ ${currentStock - quantity}</p>
                    </div>
                `;
            }
        }
        
        function simulateOutOfStock() {
            console.log('ğŸ§ª Simulating out of stock...');
            
            // Set main stock to 0
            mockProduct.soLuong = 0;
            
            // Test auto-switch
            checkStockAndSwitch();
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-warning">
                    <h6>âš ï¸ Out of Stock Simulation:</h6>
                    <p>Main stock set to: 0</p>
                    <p>Auto-switch triggered: ${selectedColor ? 'Yes' : 'No'}</p>
                    <p>Selected color: ${selectedColor || 'None'}</p>
                </div>
            `;
        }
        
        function checkStockData() {
            const stockData = { mainStock: 0, variants: { variant_1: 5, variant_2: 3, variant_3: 4 } };
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-info">
                    <h6>ğŸ“Š Stock Data:</h6>
                    <pre>${JSON.stringify(stockData, null, 2)}</pre>
                </div>
            `;
        }
        
        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Stock switch test page loaded');
            checkStockData();
        });
    </script>
</body>
</html>
