<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stock Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">Test Stock Management</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Issues</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <h6>‚ùå Issues to Fix:</h6>
                            <ul class="mb-0">
                                <li><strong>Stock Not Updating:</strong> S·ªë l∆∞·ª£ng kh√¥ng tr·ª´ khi th√™m v√†o gi·ªè</li>
                                <li><strong>No Persistence:</strong> Kh√¥ng l∆∞u s·ªë l∆∞·ª£ng khi refresh</li>
                                <li><strong>No Notifications:</strong> Kh√¥ng th√¥ng b√°o khi h·∫øt h√†ng</li>
                                <li><strong>Over-stock Bug:</strong> C√≥ th·ªÉ l∆∞u qu√° s·ªë l∆∞·ª£ng</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testStockUpdate()">Test Stock Update</button>
                        <button class="btn btn-warning mb-2" onclick="testStockPersistence()">Test Persistence</button>
                        <button class="btn btn-danger mb-2" onclick="testOverStock()">Test Over-stock</button>
                        <button class="btn btn-info mb-2" onclick="clearAllStock()">Clear All Stock</button>
                        
                        <div id="test-results" class="mt-3">
                            <p class="text-muted">Click buttons to test...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Expected Console Logs</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6>üìã When Adding to Cart:</h6>
                            <pre class="bg-light p-3">
üõí Adding to cart...
üõí Cart data: {product_id: 106, quantity: 1}
üõí Stock type: main
üõí Quantity: 1
üõí Server response: {success: true}
üì¶ Current stock before update: 10
üì¶ Quantity to subtract: 1
üì¶ Updating local stock...
üì¶ updateLocalStock called: {stockType: "main", quantity: 1}
üì¶ Current stock data: {mainStock: 10, variants: {...}}
üì¶ Main product: 10 ‚Üí 9
üì¶ Stock saved to localStorage
üîç checkStockAndSwitch called, main stock: 9
‚úÖ Main product has stock, resetting to main product
üõí Adding to local cart...
‚úÖ Cart addition completed
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Product Detail Page</h5>
                    </div>
                    <div class="card-body">
                        <a href="http://localhost:8000/sanpham/106" target="_blank" class="btn btn-success mb-3">
                            <i class="fas fa-external-link-alt"></i> Test Product Detail Page
                        </a>
                        
                        <div class="alert alert-warning">
                            <h6>‚ö†Ô∏è Test Steps:</h6>
                            <ol class="mb-0">
                                <li>Open Product Detail Page</li>
                                <li>Check initial stock: "S·ªë l∆∞·ª£ng c√≥ s·∫µn: 10"</li>
                                <li>Click "Th√™m v√†o gi·ªè" button</li>
                                <li>Check console for stock update logs</li>
                                <li>Verify stock decreases: "S·ªë l∆∞·ª£ng c√≥ s·∫µn: 9"</li>
                                <li>Refresh page and check if stock persists</li>
                                <li>Try adding more than available stock</li>
                                <li>Check for error notification</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function testStockUpdate() {
            console.log('üß™ Testing stock update...');
            
            // Mock stock data
            const mockStockData = {
                mainStock: 10,
                variants: {
                    'variant_1': 5,
                    'variant_2': 3
                }
            };
            
            localStorage.setItem('product_stock_106', JSON.stringify(mockStockData));
            
            // Simulate stock update
            const quantity = 2;
            const oldMainStock = mockStockData.mainStock;
            mockStockData.mainStock = Math.max(0, oldMainStock - quantity);
            
            localStorage.setItem('product_stock_106', JSON.stringify(mockStockData));
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ Stock Update Test:</h6>
                    <p>Main stock: ${oldMainStock} ‚Üí ${mockStockData.mainStock}</p>
                    <p>Quantity subtracted: ${quantity}</p>
                    <p>Stock saved to localStorage</p>
                </div>
            `;
        }
        
        function testStockPersistence() {
            console.log('üß™ Testing stock persistence...');
            
            const stored = localStorage.getItem('product_stock_106');
            if (stored) {
                const stockData = JSON.parse(stored);
                document.getElementById('test-results').innerHTML = `
                    <div class="alert alert-info">
                        <h6>üíæ Stock Persistence Test:</h6>
                        <pre>${JSON.stringify(stockData, null, 2)}</pre>
                        <p>‚úÖ Stock data persisted in localStorage</p>
                    </div>
                `;
            } else {
                document.getElementById('test-results').innerHTML = `
                    <div class="alert alert-warning">
                        <h6>‚ö†Ô∏è No Stock Data Found</h6>
                        <p>No stock data in localStorage</p>
                    </div>
                `;
            }
        }
        
        function testOverStock() {
            console.log('üß™ Testing over-stock prevention...');
            
            const mockStockData = {
                mainStock: 2,
                variants: {}
            };
            
            localStorage.setItem('product_stock_106', JSON.stringify(mockStockData));
            
            const requestedQuantity = 5;
            const availableStock = mockStockData.mainStock;
            
            if (requestedQuantity > availableStock) {
                document.getElementById('test-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Over-stock Prevention Test:</h6>
                        <p>Requested: ${requestedQuantity}</p>
                        <p>Available: ${availableStock}</p>
                        <p>‚úÖ Over-stock prevented!</p>
                        <p>Error: "Kh√¥ng ƒë·ªß h√†ng! Ch·ªâ c√≤n ${availableStock} s·∫£n ph·∫©m"</p>
                    </div>
                `;
            } else {
                document.getElementById('test-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>‚úÖ Stock Available:</h6>
                        <p>Requested: ${requestedQuantity}</p>
                        <p>Available: ${availableStock}</p>
                        <p>‚úÖ Stock sufficient</p>
                    </div>
                `;
            }
        }
        
        function clearAllStock() {
            localStorage.removeItem('product_stock_106');
            localStorage.removeItem('cart_data');
            
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-warning">
                    <h6>üóëÔ∏è All Stock Cleared</h6>
                    <p>Stock and cart data removed from localStorage</p>
                </div>
            `;
        }
        
        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Stock management test page loaded');
            testStockPersistence();
        });
    </script>
</body>
</html>